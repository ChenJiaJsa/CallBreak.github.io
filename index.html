<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Callbreak</title>
  <script type="text/javascript" src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
  <link rel="icon" href="favicon.ico"/>
</head>

<body id = "bodys">
    <button style="width: 100px; height: 70px;" onclick="videoClick()">视频</button>
    <button style="width: 100px; height: 70px;" onclick="imageClick()">插屏</button>
    <button style="width: 100px; height: 70px;" onclick="textClick()">banner</button>
</body>

<script type="text/javascript" charset="utf-8">
    //向head标签添加link标签
    function includeLinkStyle(url) {
      var link = document.createElement("link");
      link.rel = "stylesheet";
      link.type = "text/css";
      link.href = url;
      document.getElementsByTagName("head")[0].appendChild(link);
    }

    var content = document.getElementById("bodys");
    if(/(iPhone|iPad|iPod|iOS|Android)/i.test(navigator.userAgent)) 
    {
      //移动端设备
      content.innerHTML += `<canvas id="GameCanvas" oncontextmenu="event.preventDefault()" tabindex="0"></canvas>
      <div id="splash">
        <div class="progress-bar stripes">
          <span style="width: 0%"></span>
        </div>
      </div>`
      includeLinkStyle('style-mobile.css')
    } else 
    {
        var canvasW = 960;
        var canvasH = 540;
      //pc端
      content.innerHTML +=`<div id="GameDiv">
          <button id="googleBtn">
            <img src="./icon_google2.png" style="width:310px">
          </button>
          <canvas id="GameCanvas" width="1280" height="720"></canvas>
          <div id="splash">
            <div class="progress-bar stripes">
              <span style="width: 0%"></span>
            </div>
          </div>
        </div>`
      includeLinkStyle('style-desktop.css');
      var GameDiv = document.getElementById("GameDiv");
      GameDiv.style.top = (document.documentElement.clientHeight - canvasH) / 2 + "px";
      GameDiv.style.left = (document.documentElement.clientWidth - canvasW) / 2 + "px";

      var googleBtn = document.getElementById("googleBtn");
      googleBtn.style.position = "relative";
      googleBtn.style.bottom = -canvasH + "px";
      googleBtn.style.left = "345px";
      googleBtn.style.padding = 0;
      googleBtn.style.background = "no-repeat";
      googleBtn.style.border = 0;
      googleBtn.addEventListener("click", function() {
        // 在此处编写按钮点击事件的处理逻辑
        if(window["onGoogleClick"])
        {
          window["onGoogleClick"]();
        }
      });
    }

    window["onGoogleClick"] = ()=>{
      window.open("https://callbreak.sng.link/D7jwm/rb92");
    }
</script>



<script type="text/javascript" charset="utf-8">
 

    function videoClick(){
      ShowAd(3);
    }

    function imageClick(){
      ShowAd(2);

    }

    function textClick(){
      ShowAd(1);

    }

    var VideoUrl = "https://googleads.g.doubleclick.net/pagead/ads?ad_type=video&client=ca-games-pub-6877195875453822&description_url=https%3A%2F%2Fcb1.callbreakmaster.fun%2Fh5%2Fcb1%2Findex.html&videoad_start_delay=0&max_ad_duration=30000"
    var ImageInterstitialUrl = "https://googleads.g.doubleclick.net/pagead/ads?ad_type=image&client=ca-games-pub-6877195875453822&description_url=https%3A%2F%2Fcb1.callbreakmaster.fun%2Fh5%2Fcb1%2Findex.html&videoad_start_delay=0&max_ad_duration=30000"
    var TextBannerUrl = "https://googleads.g.doubleclick.net/pagead/ads?ad_type=text&client=ca-games-pub-6877195875453822&description_url=https%3A%2F%2Fcb1.callbreakmaster.fun%2Fh5%2Fcb1%2Findex.html&videoad_start_delay=0&max_ad_duration=30000"

    //广告节点
    var m_AdContainer = null;
    // 游戏节点
    var m_GameDiv = null;
    // 当前播放类型
    var m_Type = 0;
    // 当前广告地址
    var m_adTagUrl = "";
    
    // 当前广告
    var m_AdDisplayContainer = null;
    // 广告监听节点
    var m_adsLoader = null;
    var m_adsManager = null;

    // 定时器
    var m_intervalTimer = null;
    // 高度
    var m_Height = 0;
    var m_Width = 0;

    function Init() {
        // 创建广告容器
        m_AdContainer = document.getElementById('AdContainer');
        if (m_AdContainer == null) {
            m_AdContainer = document.createElement('div');
            m_AdContainer.id = 'AdContainer';
            m_AdContainer.style.position = 'absolute';
            m_AdContainer.style.left = '0';
            m_AdContainer.style.right = '0';
            m_AdContainer.style.top = '0';
            m_AdContainer.style.bottom = '0';
            m_AdContainer.style.visibility = 'hidden';
            m_GameDiv = document.getElementById('GameDiv');
            m_GameDiv.appendChild(m_AdContainer);
        }
    }
    Init();


    // 播放广告
    function ShowAd(type,placeId)
    {
        // type一样就表示还在播放中
        if(m_Type == type)return;
        m_Type = type;
        m_adTagUrl = ""
        switch(type)
        {
            case 1:
                m_AdContainer.style.backgroundColor = 'transparent';
                m_adTagUrl = TextBannerUrl;
            break;
            case 2:
                m_AdContainer.style.backgroundColor = '#000';
                m_adTagUrl = ImageInterstitialUrl;
            break;
            case 3:
                m_adTagUrl = VideoUrl;
            break;
        }
        if(!m_adTagUrl)return;
        if (window['google']) 
        {
            // 开始提出广告请求
            requestAds();
        }else{
            setupUIForContent();
        }
    }

    // 开启请求广告
    function requestAds()
    {
        if(m_AdDisplayContainer) 
        {
            if(m_adsLoader)
            {
                // 移除监听
                m_adsLoader.removeEventListener(
                    window['google'].ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
                    onAdsManagerLoaded.bind(this),
                    false
                );
                m_adsLoader.removeEventListener(
                    window['google'].ima.AdErrorEvent.Type.AD_ERROR,
                    onAdError.bind(this),
                false);
            }
            m_AdDisplayContainer.destroy();
            m_AdDisplayContainer.innerHTML = '';
        }
        m_AdDisplayContainer = new window['google'].ima.AdDisplayContainer(m_AdContainer);
        // 如果 requestAds 在用户操作过程中调用，则初始化容器。
        // 仅在 iOS/Android 设备上需要此操作。
        m_AdDisplayContainer.initialize(); 
        // 注册监听
        m_adsLoader = new window['google'].ima.AdsLoader(m_AdDisplayContainer);
        m_adsLoader.addEventListener(
            window['google'].ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
            onAdsManagerLoaded.bind(this),
            false);
        m_adsLoader.addEventListener(
            window['google'].ima.AdErrorEvent.Type.AD_ERROR,
            onAdError.bind(this),
        false);

        // 提出视频广告请求。
        let adsRequest = new window['google'].ima.AdsRequest();
        adsRequest.adTagUrl = m_adTagUrl;

        m_Width = m_GameDiv.clientWidth;
        m_Height = m_GameDiv.clientHeight;
        // 设置广告尺寸 除了banner外 其他广告应该全屏
        adsRequest.linearAdSlotWidth = m_Width
        adsRequest.linearAdSlotHeight = m_Height
        adsRequest.nonLinearAdSlotWidth = m_Width
        adsRequest.nonLinearAdSlotHeight =  m_Height
        m_Height = m_GameDiv.clientHeight;
        if(m_Type == 1)
        {
            adsRequest.linearAdSlotHeight = 90;
            adsRequest.nonLinearAdSlotHeight = 90;
            m_Height = 90;
        }
        // 强制使图片/文字广告以全幅界面展示
        //adsRequest.forceNonLinearFullSlot = true;
        m_adsLoader.requestAds(adsRequest);
    }


    function onAdsManagerLoaded(adsManagerLoadedEvent) {
        // 获取广告管理器。
        m_adsManager = adsManagerLoadedEvent.getAdsManager(m_AdContainer);  // 应被设置为内容视频元素
        let ima = window['google'].ima;
        if(m_adsManager)
        {
            // 为所需事件添加监听器。
            m_adsManager.addEventListener(ima.AdErrorEvent.Type.AD_ERROR,onAdError.bind(this));
            m_adsManager.addEventListener(ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,onContentPauseRequested.bind(this));
            m_adsManager.addEventListener(ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,onContentResumeRequested.bind(this));
            m_adsManager.addEventListener(ima.AdEvent.Type.ALL_ADS_COMPLETED,onAdEvent.bind(this));
            m_adsManager.addEventListener(ima.AdEvent.Type.LOADED,onAdEvent.bind(this));
            m_adsManager.addEventListener(ima.AdEvent.Type.STARTED,onAdEvent.bind(this));
            m_adsManager.addEventListener(ima.AdEvent.Type.COMPLETE,onAdEvent.bind(this));
            m_adsManager.addEventListener(ima.AdEvent.Type.SKIPPED,onAdEvent.bind(this));
            m_adsManager.addEventListener(ima.AdEvent.Type.USER_CLOSE,onAdEvent.bind(this)); 
            m_adsManager.init(m_Width, m_Height, window['google'].ima.ViewMode.NORMAL);
            m_adsManager.start();
        }
    }

    function onAdEvent(adEvent) {
        // 从事件检索广告。有些事件（例如 ALL_ADS_COMPLETED）
        // 没有相关联的广告对象。
        let ad = adEvent.getAd();
        let ima = window['google'].ima;
        switch (adEvent.type) {
            case ima.AdEvent.Type.LOADED:
                var contentType = ad.data.contentType;
                var height = ad.data.height;
                setupUIForAds(contentType, height);
                break;
            case ima.AdEvent.Type.STARTED:
                // 此事件表示广告已启动 - 视频播放器
                // 可以调整用户界面，例如显示暂停按钮和
                // 剩余时间。
                // if (ad.isLinear()) {
                //     // 对于线性广告，可以启动计时器来查看
                //     // 剩余时间。
                //     m_intervalTimer = setInterval(() => {
                //         let remainingTime = m_adsManager.getRemainingTime();
                //     }, 300); // every 300ms
                // }
                break;
            case ima.AdEvent.Type.COMPLETE:
                // 此事件表示广告已完成 - 视频播放器
                // 可以执行相应的用户界面操作，例如删除
                // 剩余时间检测的定时器。
                // if (ad.isLinear()) {
                //     clearInterval(m_intervalTimer);
                // }
                setupUIForContent('COMPLETE');
                break;
            case  ima.AdEvent.Type.SKIPPED:
                //在用户跳过广告时触发
                //console.log("跳过广告");
                setupUIForContent('SKIPPED');
                break;
            case ima.AdEvent.Type.USER_CLOSE:
                //用户关闭广告
                //console.log("关闭广告");
                setupUIForContent('USER_CLOSE');
                break;
            case ima.AdEvent.Type.CLICK:
                //用户点击广告
                break;
            case ima.AdErrorEvent.Type.AD_ERROR:
                //出现错误
                console.log("AD_ERROR");
                setupUIForContent('AD_ERROR');
                break;    
        }
    }

    function onAdError(adErrorEvent) {
        setupUIForContent(adErrorEvent);
        // 处理错误日志记录。
        console.log(adErrorEvent.getError());
    }

    function onContentPauseRequested() {
        //videoContent.pause();
        // 您应该使用此函数设置用户界面来展示广告（例如
        // 展示广告计时器倒计时、停用搜寻等）
        setupUIForAds(null,0);
    }

    function onContentResumeRequested() {
        //videoContent.play();
        // 您应该使用此函数确保用户界面已准备好
        // 播放内容。发布商负责
        // 在必要时实施此函数。
        setupUIForContent();

    }

    function setupUIForAds(contentType, height){
        
        m_AdContainer.style.backgroundColor = "#f00";
        // 请求image有时会获取到高为60的banner图片，暂时不知如何处理，当作失败对待，防止整屏被banner覆盖不能操作游戏了
        if(contentType != 'text' && height == 60){
            setupUIForContent();
            return;
        }
        if(contentType == 'text'){
            console.log(contentType);
            let y =(m_GameDiv.clientHeight - 80)+'px';
            m_AdContainer.height = '63px';
            m_AdContainer.style.top = y;
        }else{
            m_AdContainer.style.top = 0;
            m_AdContainer.height = m_GameDiv.clientHeight;
        }
        m_AdContainer.style.visibility = 'visible';
    }

    function setupUIForContent(adErrorEvent = null){
        console.log(" ad over status " + adErrorEvent);
        // if(preloadedRewardedVideoCallbackObj){
        //     preloadedRewardedVideoCallbackObj.showRewardedVideoCallback(adErrorEvent);
        //     preloadedRewardedVideoCallbackObj = null;
        // }
        m_AdContainer.style.visibility = 'hidden';
        
    }

    function CloseAd(type)
    {

    }

</script>

<script type="text/javascript">
  
</script>

</html>
